{{- if .Values.client.node.enabled }}
---
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "sample-service.fullname" . }}-node
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "sample-service.labels" . | nindent 4 }}
    app.kubernetes.io/component: node-client
spec:
  restartPolicy: {{ .Values.restartPolicy }}
  containers:
    - name: node-client
      image: "{{ .Values.client.node.image }}:{{ .Values.client.node.tag | default "latest" }}"
      imagePullPolicy: {{ .Values.client.node.pullPolicy }}
      env:
        - name: SECRETS_ROUTER_URL
          value: {{ .Values.secretsRouter.url | quote }}
        - name: TEST_NAMESPACE
          value: {{ .Values.secretsRouter.namespace | quote }}
        {{- if .Values.client.node.secrets }}
        {{- $availableSecrets := list }}
        {{- range $secretKey, $secretPath := .Values.client.node.secrets }}
        {{- $availableSecrets = append $availableSecrets $secretKey }}
        - name: SECRET_{{ $secretKey | upper | replace "-" "_" }}
          value: {{ $secretPath | quote }}
        {{- end }}
        - name: AVAILABLE_SECRETS
          value: {{ join "," $availableSecrets | quote }}
        {{- else }}
        - name: TEST_SECRET_NAME
          value: {{ .Values.testSecret.name | quote }}
        - name: TEST_SECRET_KEY
          value: "password"
        {{- end }}
      resources:
        {{- toYaml .Values.resources | nindent 8 }}
  terminationGracePeriodSeconds: 0
{{- end }}
