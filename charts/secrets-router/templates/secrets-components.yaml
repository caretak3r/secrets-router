{{- if .Values.secretStores.enabled }}
{{- range $storeName, $storeConfig := .Values.secretStores.stores }}
---
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: {{ $storeName }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "secrets-router.labels" $ | nindent 4 }}
    app.kubernetes.io/component: secret-store
spec:
  type: {{ $storeConfig.type }}
  version: v1
  metadata:
  {{- if eq $storeConfig.type "secretstores.kubernetes" }}
    {{- if $storeConfig.namespaces }}
    {{- $namespaces := join "," $storeConfig.namespaces }}
    - name: allowedNamespaces
      value: {{ $namespaces | quote }}
    {{- else }}
    - name: allowedNamespaces
      value: {{ $.Release.Namespace | quote }}
    {{- end }}
    - name: defaultSecretStore
      value: {{ $storeConfig.defaultSecretStore | default "false" | quote }}
  {{- else if eq $storeConfig.type "secretstores.aws.secretsmanager" }}
    - name: region
      value: {{ $storeConfig.region | default "us-east-1" | quote }}
    {{- if $storeConfig.pathPrefix }}
    - name: pathPrefix
      value: {{ $storeConfig.pathPrefix | quote }}
    {{- end }}
  {{- end }}
  {{- if $storeConfig.auth }}
  auth:
    {{- if $storeConfig.auth.secretStore }}
    secretStore: {{ $storeConfig.auth.secretStore }}
    {{- end }}
    {{- if $storeConfig.auth.metadata }}
    metadata:
      {{- range $key, $value := $storeConfig.auth.metadata }}
      - name: {{ $key }}
        value: {{ $value | quote }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}

